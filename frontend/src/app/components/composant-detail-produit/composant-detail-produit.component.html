<div class="detail-container">
  <ng-container *ngIf="produit$ | async as produit; else pasDeProduit">
    <mat-card class="product-detail-card">
      
      <!-- Header avec badges scores -->
      <div class="product-header">
        <div class="header-content">
          <div class="product-info">
            <h1 class="product-title">{{ produit.product_name || produit.name }}</h1>
            <h2 class="product-brand">{{ produit.brands || produit.brand }}</h2>
            <p class="product-quantity" *ngIf="produit.quantity">Quantit√© : {{ produit.quantity }}</p>
          </div>
          
          <div class="scores-section" *ngIf="hasScores(produit)">
            <!-- NutriScore Badge -->
            <div class="score-badge nutri-score" 
                 *ngIf="produit.nutriscore_score !== undefined"
                 [style.background-color]="obtenirCouleurNutriScore(produit)">
              <span class="score-label">Nutri-Score</span>
              <span class="score-grade">{{ obtenirGradeNutriScore(produit.nutriscore_score) }}</span>
              <span class="score-value">{{ produit.nutriscore_score }}</span>
            </div>
            
            <!-- EcoScore Badge -->
            <div class="score-badge eco-score" 
                 *ngIf="produit.ecoscore_grade"
                 [style.background-color]="obtenirCouleurEcoScore(produit.ecoscore_grade)">
              <span class="score-label">Eco-Score</span>
              <span class="score-grade">{{ produit.ecoscore_grade.toUpperCase() }}</span>
              <span class="score-value" *ngIf="produit.ecoscore_score">{{ produit.ecoscore_score }}/100</span>
            </div>
          </div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="header-buttons">
          <!-- Bouton Like -->
          <button mat-icon-button class="like-button-detail" 
                  [class.liked]="isLiked" 
                  (click)="toggleLike()"
                  [attr.aria-label]="isLiked ? 'Retirer des favoris' : 'Ajouter aux favoris'">
            <span class="like-icon">{{ isLiked ? '‚ù§Ô∏è' : 'ü§ç' }}</span>
          </button>
          
          <!-- Bouton Supprimer (Admin uniquement) -->
          <button mat-icon-button class="delete-button-detail" 
                  *ngIf="estAdmin"
                  (click)="supprimerProduit()"
                  [attr.aria-label]="'Supprimer le produit'">
            <span class="delete-icon">üóëÔ∏è</span>
          </button>
        </div>
      </div>

      <mat-card-content class="product-content">
        
        <!-- Section Informations nutritionnelles -->
        <mat-expansion-panel class="info-panel" [expanded]="true">
          <mat-expansion-panel-header>
            <mat-panel-title>
              üìä Informations nutritionnelles (pour 100g)
            </mat-panel-title>
          </mat-expansion-panel-header>
          
          <div class="nutrition-grid">
            <!-- Valeurs √©nerg√©tiques -->
            <div class="nutrition-category">
              <h4>‚ö° √ânergie</h4>
              <div class="nutrition-item">
                <span class="label">Calories</span>
                <span class="value">{{ getFormattedValue(produit.calories || produit.energy_kcal_100g, ' kcal') }}</span>
              </div>
            </div>

            <!-- Macronutriments -->
            <div class="nutrition-category">
              <h4>ü•© Macronutriments</h4>
              <div class="nutrition-item">
                <span class="label">Prot√©ines</span>
                <span class="value">{{ getFormattedValue(produit.proteins_100g || produit.protein_100g || produit.protein, ' g') }}</span>
              </div>
              <div class="nutrition-item">
                <span class="label">Glucides</span>
                <span class="value">{{ getFormattedValue(produit.carbohydrates_100g, ' g') }}</span>
              </div>
              <div class="nutrition-item">
                <span class="label">Sucres</span>
                <span class="value">{{ getFormattedValue(produit.sugars_100g || produit.sugars, ' g') }}</span>
              </div>
              <div class="nutrition-item">
                <span class="label">Mati√®res grasses</span>
                <span class="value">{{ getFormattedValue(produit.fat_100g, ' g') }}</span>
              </div>
              <div class="nutrition-item">
                <span class="label">Graisses satur√©es</span>
                <span class="value">{{ getFormattedValue(produit.saturated_fat_100g || produit.saturatedFat, ' g') }}</span>
              </div>
            </div>

            <!-- Fibres et min√©raux -->
            <div class="nutrition-category">
              <h4>üåæ Fibres & Min√©raux</h4>
              <div class="nutrition-item" *ngIf="produit.fiber_100g || produit.fiber">
                <span class="label">Fibres</span>
                <span class="value">{{ getFormattedValue(produit.fiber_100g || produit.fiber, ' g') }}</span>
              </div>
              <div class="nutrition-item">
                <span class="label">Sel</span>
                <span class="value">{{ getFormattedValue(produit.salt_100g || produit.salt, ' g') }}</span>
              </div>
              <div class="nutrition-item" *ngIf="produit.sodium_100g">
                <span class="label">Sodium</span>
                <span class="value">{{ getFormattedValue(produit.sodium_100g, ' g') }}</span>
              </div>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- Section Additifs (si pr√©sents) -->
        <mat-expansion-panel class="info-panel" *ngIf="hasAdditives(produit)">
          <mat-expansion-panel-header>
            <mat-panel-title>
              ‚öóÔ∏è Additifs alimentaires ({{ produit.additives_n || produit.additives?.length }})
            </mat-panel-title>
            <mat-panel-description>
              {{ produit.additives_n || produit.additives?.length }} additif(s) d√©tect√©(s)
            </mat-panel-description>
          </mat-expansion-panel-header>
          
          <div class="additives-container">
            <div class="additives-warning">
              <p><strong>‚ö†Ô∏è Attention :</strong> Ce produit contient des additifs alimentaires. Certains peuvent avoir des effets ind√©sirables chez les personnes sensibles.</p>
            </div>
            
            <h5>Liste d√©taill√©e des additifs :</h5>
            <div class="additives-detailed">
              <div class="additive-item" *ngFor="let additive of produit.additives">
                <span class="additive-code">{{ additive.split(' - ')[0] }}</span>
                <span class="additive-name">{{ additive.split(' - ')[1] || additive }}</span>
              </div>
            </div>
            
            <div class="additives-summary" *ngIf="produit.additives_en">
              <h5>R√©sum√© :</h5>
              <p>{{ produit.additives_en }}</p>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- Section Cat√©gories -->
        <mat-expansion-panel class="info-panel" *ngIf="produit.categories_en || produit.categories">
          <mat-expansion-panel-header>
            <mat-panel-title>
              üè∑Ô∏è Cat√©gories de produit
            </mat-panel-title>
            <mat-panel-description>
              Classification du produit
            </mat-panel-description>
          </mat-expansion-panel-header>
          
          <div class="categories-detailed">
            <div class="category-hierarchy">
              <h5>Hi√©rarchie des cat√©gories :</h5>
              <div class="category-path">
                <span class="category-item" *ngFor="let category of formatCategories(produit.categories_en || produit.categories!); let last = last">
                  {{ category }}
                  <span *ngIf="!last" class="category-separator">‚Üí</span>
                </span>
              </div>
            </div>
            
            <div class="category-details" *ngIf="produit.main_category_en || produit.food_groups_en">
              <div class="detail-item" *ngIf="produit.main_category_en">
                <strong>Cat√©gorie principale :</strong> {{ produit.main_category_en }}
              </div>
              <div class="detail-item" *ngIf="produit.food_groups_en">
                <strong>Groupe alimentaire :</strong> {{ produit.food_groups_en }}
              </div>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- Section Origine et informations g√©n√©rales -->
        <mat-expansion-panel class="info-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              üåç Origine et informations g√©n√©rales
            </mat-panel-title>
            <mat-panel-description>
              Provenance et caract√©ristiques du produit
            </mat-panel-description>
          </mat-expansion-panel-header>
          
          <div class="general-info">
            <div class="info-grid">
              <div class="info-item" *ngIf="produit.countries_en">
                <span class="info-label">üåç Pays d'origine</span>
                <span class="info-value">{{ produit.countries_en }}</span>
              </div>
              
              <div class="info-item" *ngIf="produit.quantity">
                <span class="info-label">üì¶ Quantit√©</span>
                <span class="info-value">{{ produit.quantity }}</span>
              </div>
              
              <div class="info-item" *ngIf="produit.fruits_vegetables_nuts_estimate_from_ingredients_100g !== undefined">
                <span class="info-label">ü•¨ Estimation fruits/l√©gumes/noix</span>
                <span class="info-value">{{ produit.fruits_vegetables_nuts_estimate_from_ingredients_100g }}%</span>
              </div>
              
              <div class="info-item" *ngIf="produit.nutrition_score_fr_100g !== undefined">
                <span class="info-label">üìä Score nutritionnel France</span>
                <span class="info-value">{{ produit.nutrition_score_fr_100g }}</span>
              </div>
            </div>
          </div>
        </mat-expansion-panel>

        <!-- Section M√©tadonn√©es -->
        <mat-expansion-panel class="info-panel" *ngIf="produit.createdAt || produit.updatedAt">
          <mat-expansion-panel-header>
            <mat-panel-title>
              üìÖ Informations de base de donn√©es
            </mat-panel-title>
            <mat-panel-description>
              Dates de cr√©ation et modification
            </mat-panel-description>
          </mat-expansion-panel-header>
          
          <div class="metadata-info">
            <div class="metadata-item" *ngIf="produit.createdAt">
              <span class="metadata-label">Cr√©√© le :</span>
              <span class="metadata-value">{{ produit.createdAt | date:'dd/MM/yyyy √† HH:mm' }}</span>
            </div>
            <div class="metadata-item" *ngIf="produit.updatedAt">
              <span class="metadata-label">Mis √† jour le :</span>
              <span class="metadata-value">{{ produit.updatedAt | date:'dd/MM/yyyy √† HH:mm' }}</span>
            </div>
          </div>
        </mat-expansion-panel>

      </mat-card-content>

      <mat-card-actions class="product-actions">
        <button mat-raised-button color="primary" (click)="retournerALaListe()">
          ‚Üê Retour √† la liste
        </button>
      </mat-card-actions>
    </mat-card>
  </ng-container>
  
  <ng-template #pasDeProduit>
    <mat-card class="error-card">
      <mat-card-content>
        <div class="error-content">
          <div class="error-icon">üö´</div>
          <h2>Produit non trouv√©</h2>
          <p>Le produit demand√© n'existe pas ou n'est plus disponible.</p>
        </div>
        <div class="error-actions">
          <button mat-raised-button color="primary" (click)="retournerALaListe()">
            ‚Üê Retour √† la liste
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </ng-template>
</div>